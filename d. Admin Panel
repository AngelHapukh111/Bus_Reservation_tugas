/* ================= FILE BUS ================= */
void saveBuses() { // menyimpan semua data bus dan kursi ke file
    FILE *fp = fopen("buses.txt", "w");
    if (!fp) return;
    fprintf(fp, "%d\n", busCount); // jumlah bus
    for (int i = 0; i < busCount; i++) {
        struct Bus *b = &buses[i];
        // info dasar bus
        fprintf(fp, "BusNumber: %d\nFrom: %s\nTo: %s\nRows: %d TotalSeats: %d AvailableSeats: %d\n",
                b->busNumber, b->from, b->to,
                b->rows, b->totalSeats, b->availableSeats);
        // layout kursi per baris
        for (int r = 0; r < b->rows; r++) {
            fprintf(fp, "Row %c: ", 'A' + r);
            for (int c = 0; c < COL; c++)
                fprintf(fp, "%d ", b->seat[r][c]);
            fprintf(fp, "\n");
        }
        fprintf(fp, "----\n"); // pemisah antar bus
    }
    fclose(fp);
}

void loadBuses() { // membaca data bus dari file
    FILE *fp = fopen("buses.txt", "r");
    if (!fp) return;
    fscanf(fp, "%d\n", &busCount);
    for (int i = 0; i < busCount; i++) {
        struct Bus *b = &buses[i];
        char temp[100];
        fscanf(fp, "BusNumber: %d\n", &b->busNumber);
        fscanf(fp, "From: %[^\n]\n", b->from);
        fscanf(fp, "To: %[^\n]\n", b->to);
        fscanf(fp, "Rows: %d TotalSeats: %d AvailableSeats: %d\n",
               &b->rows, &b->totalSeats, &b->availableSeats);
        b->active = 1;
        for (int r = 0; r < b->rows; r++) {
            fscanf(fp, "Row %*c:"); // skip label row
            for (int c = 0; c < COL; c++)
                fscanf(fp, "%d", &b->seat[r][c]);
            fgets(temp, sizeof(temp), fp); // pindah ke baris berikutnya
        }
        fgets(temp, sizeof(temp), fp); // skip separator "----"
    }
    fclose(fp);
}

/* ================= SEAT ================= */
void showSeatLayout(struct Bus *bus) { // menampilkan layout kursi
    printf("\nSeat Layout:\n");
    for (int i = 0; i < bus->rows; i++) {
        printf("%c ", 'A' + i);
        for (int j = 0; j < COL; j++)
            printf(bus->seat[i][j] ? "[X] " : "[O] "); // X=terisi, O=kosong
        printf("\n");
    }
}

/* ================= SORTING ================= */
void sortBusesByNumber() { // mengurutkan bus berdasarkan nomor
    for (int i = 0; i < busCount - 1; i++)
        for (int j = 0; j < busCount - i - 1; j++)
            if (buses[j].busNumber > buses[j + 1].busNumber) {
                struct Bus temp = buses[j];
                buses[j] = buses[j + 1];
                buses[j + 1] = temp;
            }
}

/* ================= BUS MANAGEMENT ================= */
void clearSeats(struct Bus *bus) { // kosongkan semua kursi
    for (int i = 0; i < MAX_ROW; i++)
        for (int j = 0; j < COL; j++)
            bus->seat[i][j] = 0;
}

void addBus() { // menambahkan bus baru
    struct Bus *bus;
    if (busCount < MAX_BUS)
        bus = &buses[busCount++];
    else {
        printf("Overwrite bus lama? (y/n): ");
        char c; scanf(" %c", &c);
        if (c != 'y' && c != 'Y') return;
        for (int i = 1; i < MAX_BUS; i++)
            buses[i - 1] = buses[i];
        bus = &buses[MAX_BUS - 1];
    }
    clearScreen();
    printf("Bus Number: "); scanf("%d", &bus->busNumber);
    printf("From: "); scanf(" %[^\n]", bus->from);
    printf("To: "); scanf(" %[^\n]", bus->to);
    int size;
    printf("1.Small 2.Big: "); scanf("%d", &size);
    bus->rows = (size == 2) ? 6 : 3;
    bus->totalSeats = bus->rows * 4;
    bus->availableSeats = bus->totalSeats;
    bus->active = 1;
    clearSeats(bus);
    saveBuses(); // simpan ke file
    printf("Bus berhasil ditambahkan!\n");
    pauseScreen();
}

void viewBuses() { // menampilkan semua bus
    if (busCount == 0) {
        printf("Tidak ada jadwal bus\n");
        pauseScreen();
        return;
    }
    sortBusesByNumber(); // urutkan berdasarkan nomor
    for (int i = 0; i < busCount; i++) {
        printf("\nBus %d | %s -> %s | %d/%d seats\n",
               buses[i].busNumber, buses[i].from, buses[i].to,
               buses[i].availableSeats, buses[i].totalSeats);
        showSeatLayout(&buses[i]); // tampilkan kursi
    }
    pauseScreen();
}

/* ================= ADMIN MENU ================= */
void adminMenu() { // menu admin
    int c;
    do {
        clearScreen();
        printf("1.Add Bus\n2.View Buses\n3.Logout\nChoose: "); scanf("%d", &c);
        if (c == 1) addBus();
        else if (c == 2) viewBuses();
    } while (c != 3);
}

#include <stdio.h>
#include <string.h>
#include <stdlib.h>

/* ================= CONSTANT VALUES ================= */
const int MAX_BUS = 3;
const int MAX_ROW = 6;
const int COL = 4;

/* ================= STRUCTS ================= */

struct Bus {
    int active;
    int busNumber;
    char from[50];
    char to[50];
    int rows;
    int totalSeats;
    int availableSeats;
    int seat[6][4];
};

/* ================= GLOBAL DATA ================= */

struct Bus buses[3];
int busCount = 0;

char adminUsername[50] = "";
char adminPassword[50] = "";

/* ================= UTILITY ================= */

void pauseScreen() {
    printf("\nPress ENTER to continue...");
    getchar(); getchar();
}

void clearScreen() {
#ifdef _WIN32
    system("cls");
#else
    system("clear");
#endif
}

/* ================= FILE PROCESSING ================= */

void saveAdmin() {
    FILE *fp = fopen("admin.txt", "w");
    if (fp) {
        fprintf(fp, "%s\n%s\n", adminUsername, adminPassword);
        fclose(fp);
    }
}

void loadAdmin() {
    FILE *fp = fopen("admin.txt", "r");
    if (fp) {
        fscanf(fp, "%s", adminUsername);
        fscanf(fp, "%s", adminPassword);
        fclose(fp);
    }
}

void saveBuses() {
    FILE *fp = fopen("buses.txt", "w");
    if (!fp) return;

    fprintf(fp, "%d\n", busCount);
    for (int i = 0; i < busCount; i++) {
        struct Bus *b = &buses[i];
        fprintf(fp, "%d %s %s %d %d %d\n",
                b->busNumber, b->from, b->to,
                b->rows, b->totalSeats, b->availableSeats);

        for (int r = 0; r < MAX_ROW; r++)
            for (int c = 0; c < COL; c++)
                fprintf(fp, "%d ", b->seat[r][c]);
        fprintf(fp, "\n");
    }
    fclose(fp);
}

void loadBuses() {
    FILE *fp = fopen("buses.txt", "r");
    if (!fp) return;

    fscanf(fp, "%d", &busCount);
    for (int i = 0; i < busCount; i++) {
        struct Bus *b = &buses[i];
        fscanf(fp, "%d %s %s %d %d %d",
               &b->busNumber, b->from, b->to,
               &b->rows, &b->totalSeats, &b->availableSeats);
        b->active = 1;

        for (int r = 0; r < MAX_ROW; r++)
            for (int c = 0; c < COL; c++)
                fscanf(fp, "%d", &b->seat[r][c]);
    }
    fclose(fp);
}

/* ================= SEAT DISPLAY ================= */

void showSeatLayout(struct Bus *bus) {
    printf("\nSeat Layout:\n");
    for (int i = 0; i < bus->rows; i++) {
        printf("%c ", 'A' + i);
        for (int j = 0; j < COL; j++) {
            printf(bus->seat[i][j] ? "[X] " : "[O] ");
        }
        printf("\n");
    }
}

/* ================= SORTING ================= */

void sortBusesByNumber() {
    for (int i = 0; i < busCount - 1; i++) {
        for (int j = 0; j < busCount - i - 1; j++) {
            if (buses[j].busNumber > buses[j + 1].busNumber) {
                struct Bus temp = buses[j];
                buses[j] = buses[j + 1];
                buses[j + 1] = temp;
            }
        }
    }
}

/* ================= ADMIN ================= */

int adminLogin() {
    char u[50], p[50];
    clearScreen();
    printf("Username: ");
    scanf("%s", u);
    printf("Password: ");
    scanf("%s", p);

    if (strcmp(u, adminUsername) == 0 &&
        strcmp(p, adminPassword) == 0)
        return 1;

    printf("Login failed!\n");
    pauseScreen();
    return 0;
}

void adminRegister() {
    clearScreen();
    printf("New Username: ");
    scanf("%s", adminUsername);
    printf("New Password: ");
    scanf("%s", adminPassword);
    saveAdmin();
    printf("Admin created!\n");
    pauseScreen();
}

/* ================= BUS MANAGEMENT ================= */

void clearSeats(struct Bus *bus) {
    for (int i = 0; i < MAX_ROW; i++)
        for (int j = 0; j < COL; j++)
            bus->seat[i][j] = 0;
}

void addBus() {
    struct Bus *bus;

    if (busCount < MAX_BUS)
        bus = &buses[busCount++];
    else {
        printf("Max bus reached. Overwrite oldest? (y/n): ");
        char c; scanf(" %c", &c);
        if (c != 'y' && c != 'Y') return;
        for (int i = 1; i < MAX_BUS; i++)
            buses[i - 1] = buses[i];
        bus = &buses[MAX_BUS - 1];
    }

    clearScreen();
    printf("Bus Number: ");
    scanf("%d", &bus->busNumber);
    printf("From: ");
    scanf(" %[^\n]", bus->from);
    printf("To: ");
    scanf(" %[^\n]", bus->to);

    int size;
    printf("1.Small 2.Big: ");
    scanf("%d", &size);

    bus->rows = (size == 2) ? 6 : 3;
    bus->totalSeats = bus->rows * 4;
    bus->availableSeats = bus->totalSeats;
    bus->active = 1;

    clearSeats(bus);
    saveBuses();

    printf("Bus added!\n");
    pauseScreen();
}

void viewBuses() {
    if (busCount == 0) {
        printf("Tidak ada schedule\n");
        pauseScreen();
        return;
    }

    sortBusesByNumber();

    for (int i = 0; i < busCount; i++) {
        printf("\nBus %d | %s -> %s | %d/%d seats\n",
               buses[i].busNumber,
               buses[i].from,
               buses[i].to,
               buses[i].availableSeats,
               buses[i].totalSeats);
        showSeatLayout(&buses[i]);
    }
    pauseScreen();
}

/* ================= BOOKING ================= */

void bookTicket() {
    if (busCount == 0) {
        printf("Tidak ada schedule\n");
        pauseScreen();
        return;
    }

    viewBuses();

    int ch;
    printf("Choose bus number: ");
    scanf("%d", &ch);

    for (int i = 0; i < busCount; i++) {
        if (buses[i].busNumber == ch) {
            struct Bus *b = &buses[i];

            char row; int col;
            printf("Row: ");
            scanf(" %c", &row);
            printf("Col: ");
            scanf("%d", &col);

            int r = row - 'A';
            int c = col - 1;

            if (r < 0 || r >= b->rows || c < 0 || c >= 4 || b->seat[r][c]) {
                printf("Invalid seat!\n");
                pauseScreen();
                return;
            }

            b->seat[r][c] = 1;
            b->availableSeats--;
            saveBuses();

            printf("Booking successful!\n");
            pauseScreen();
            return;
        }
    }

    printf("Bus not found.\n");
    pauseScreen();
}

/* ================= MENUS ================= */

void adminMenu() {
    int c;
    do {
        clearScreen();
        printf("1.Add Bus\n2.View Buses\n3.Logout\nChoose: ");
        scanf("%d", &c);
        if (c == 1) addBus();
        else if (c == 2) viewBuses();
    } while (c != 3);
}

void customerMenu() {
    int c;
    do {
        clearScreen();
        printf("1.Book Ticket\n2.View Buses\n3.Back\nChoose: ");
        scanf("%d", &c);
        if (c == 1) bookTicket();
        else if (c == 2) viewBuses();
    } while (c != 3);
}

/* ================= MAIN ================= */

int main() {
    loadAdmin();
    loadBuses();

    int c;
    do {
        clearScreen();
        printf("1.Customer\n2.Admin Login\n3.Register Admin\n4.Exit\nChoose: ");
        scanf("%d", &c);

        if (c == 1) customerMenu();
        else if (c == 2 && adminLogin()) adminMenu();
        else if (c == 3) adminRegister();

    } while (c != 4);

    return 0;
}
